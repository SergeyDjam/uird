{"name":"Uird","tagline":"UIRD - Unified Init Ram Disk system ","body":"### Базовое описание основных принципов\r\n\r\nПоддерживаемые расширения в MagOS Linux по умолчанию:\r\n\r\n    *.ROM - RO слой\r\n    *.RWM - RW слой\r\n    *.XZM - RO слой с squashfs \r\n\r\n    *.RWM.ENC - RW слой криптованый\r\n    *.ROM.ENC - RO слой криптованый\r\n\r\nВвиду множественности параметров ядра введен префикс параметров '**uird**'  (Unified Init Ram Disk): \r\n\r\n    uird.basecfg=           - расположение базаового конфигурационного файла basecfg.ini\r\n    uird.config=            - расположение конфигурационного файла системы MagOS.ini\r\n    ??? uird.sgnfile=\r\n    uird.ro=                - фильтр для модулей, которые монтируются в режиме RO\r\n    uird.rw=                - фильтр для модулей, которые монтируются в режиме RW\r\n    uird.copy2ram=          - фильтр для модулей, которые копируются в RAM\r\n    uird.copy2cache=        - фильтр для модулей, которые копируются в КЭШ\r\n    uird.ramsize=           - размер RAM\r\n    uird.ip=                - IP:GW:MASK , если не указан, то используется DHCP\r\n    uird.netfsopt=          - дополнительные опции монтирования сетевых ФС: sshfs,nfs,curlftpfs\r\n    uird.load=              - фильтр для модулей, которые необходимо подключить на этапе загрузки\r\n    uird.noload=            - фильтр для модулей, которые необходимо пропустить во время загрузки\r\n    uird.from=              - источники, где лежат модули для системы\r\n    uird.cache=             - источники, в которые стоит синхронизировать модули \r\n    uird.homes=             - источники, где хранятся домашние директории пользователей \r\n    uird.changes=           - источник, где хранить персистентные изменения\r\n    uird.machines=          - источник, где храняться машинно-зависимые персистентные изменения\r\n\r\nВводится базовый уровень layer-base и соответствующий параметр uird.from=:\r\n\r\n    uird.from=/MagOS;/MagOS-Data;MagOS.iso;http://magos.sibsau.ru/repository/netlive/2014.64/MagOS;ftp://server/path/\r\n\r\nВводится уровень кеша layer-cache и соответствующий параметр uird.cache=. Служит для синхронизации удаленных репозиториев в локальные или частные (INTRANET) репозитории, а также для обновления системы.\r\n\r\n    uird.cache=/MagOS/cache;/MagOS-Data/cache;/MagOS-Data/netlive\r\n\r\nВводится уровень домашних директорий пользователя layer-homes и соответствующий параметр uird.homes=:\r\n\r\n    uird.homes=/MagOS-Data/homes;/MagOS-Data/home.img;nfs://magos.sibsau.ru/homes/n/e/neobht;ftp://server/path/\r\n\r\nВсе директории пользователя из различных источников каскадно-объединяются посредством AUFS и монтируются в /home. Более приоритетным является самый первый источник, затем в порядке перечисления уменьшается приоритет.\r\n\r\n\r\n### Типы источников\r\n\r\n*     **/path/dir**   - директория на любом доступном носителе\r\n*     **/dev/[..]/path/dir**   - директория на заданном носителе\r\n*     **file-dvd.iso, file.img**   - образ диска (ISO, образ блочного устройства)\r\n*     **http://server/path/...**   - источник доступный по HTTP (используется httpfs) \r\n*     **ssh://server/path/...**   - источник доступный по SSH (используется sshfs)\r\n*     **ftp://server/path/...**   - источник доступный по FTP (используется curlftpfs)\r\n*     **nfs://server/path/...**   - источник доступный по NFS \r\n\r\n### Порядок инициализации системы\r\n\r\n1. Осуществляется поиск конфигурационного файла по пути, указанному в параметре uird.basecfg=\r\n2. Устанавливаются параметры из конфигурационного файла, которые еще не установлены в параметрах ядра\r\n3. Происходит монтирование источников **base**-уровня в порядке, указанном в параметре uird.from= \r\n4. Происходит монтирование источников **cache**-уровня в порядке, указанном в параметре uird.cache= \r\n5. Происходит монтирование источников **homes**-уровня в порядке, указанном в параметре uird.homes= \r\n6. Происходит подключение в самый _верхний_ уровень AUFS источника персистентных изменений, указанного в параметре uird.changes=\r\n7. Осуществляется синхронизация base-уровня в cache-уровень с учетом параметра uird.copy2cache=, а также соответствия подуровней. Если подуровней cache-уровня меньше, чем base-уровня, то оставшиеся подуровни синхронизируются в RAM.\r\n\r\n\r\n            ├── layer-base       ==>      ├── layer-cache\r\n            │   ├── 0            -->      │   ├── 0\r\n            │   ├── 1            -->      │   ├── 1\r\n            │   ├── ...          -->      │   └── ...\r\n            │   └── ...          -->      │   RAM\r\n\r\n\r\n8. Осуществляется синхронизация base,cache-уровней в RAM с учетом параметра uird.copy2ram=\r\n9. Осуществляется поиск модулей в RAM, cache-уровне, base-уровне и подключение их на _[верхний-1]_ уровень AUFS с учетом фильтров, указанных в параметрах uird.load=,uird.noload=,uird.ro=,uird.rw=.\r\n10. Осуществляется каскадное объединение источников homes-уровня и подключение их в /home\r\n11. Выполняются скрипты rc.preinit\r\n\r\n### Структура конфигурационного файла basecfg.ini по умолчанию\r\n\r\n    uird.config=MagOS.ini\r\n    uird.ramsize=70%\r\n    uird.ro=*.xzm;*.rom;*.rom.enc;*.pfs;*.sfs\r\n    uird.rw=*.rwm;*.rwm.enc\r\n    uird.load=*\r\n    uird.noload=/optional/;/machines/;/cache/;/homes/,/changes/\r\n    uird.from=/MagOS;/MagOS-Data\r\n    uird.changes=/MagOS-Data/changes\r\n    uird.cache=/MagOS-Data/cache\r\n    uird.machines=/MagOS-Data/machines\r\n    uird.homes=/MagOS-Data/homes\r\n    \r\n!!! Если параметр uird.basecfg= не задан, то используется /basecfg.ini внутри initrd (не реализовано, пока используется только конфиг внутри initrd).\r\n\r\n### Структура системной директории \r\n\r\n      /memory/\r\n      ├── bundles                   - точка монтирования модулей\r\n      │   ├── 00-kernel.xzm\r\n      │   ├── 01-firmware.xzm\r\n      │   ├── 10-core.xzm\r\n      │   ├── 80-eepm-1.5.2.xzm\r\n      │   └── ...                   - и т.д.\r\n      ├── changes                   - точка монтирования для хранения изменений \r\n      │   ├── etc\r\n      │   ├── home\r\n      │   ├── memory\r\n      │   ├── run\r\n      │   ├── var\r\n      │   └── ...                   - и т.д.\r\n      ├── data                      - точка монтирования источников\r\n      │   ├── cache                     - кеш уровня\r\n      │   ├── homes                     - homes уровня\r\n      │   ├── machines                  - (зарезервировано)\r\n      │   └── from                      - базового уровня\r\n      ├── layer-base                - точка монтирования базового уровня\r\n      │   ├── 0                         - ресурс первого источника\r\n      │   ├── 1                         - ресурс второго источника (в порядке перечисления в uird.from=)\r\n      │   └── ...                       - и т.д.\r\n      ├── layer-cache               - точка монтирования кеш уровня\r\n      │   ├── 0                         - ресурс первого источника\r\n      │   ├── 1                         - ресурс второго источника (в порядке перечисления в uird.cache=)\r\n      │   └── ...                       - и т.д.\r\n      ├── layer-homes               - точка монтирования homes уровня\r\n      │   ├── 0                         - ресурс первого источника\r\n      │   ├── 1                         - ресурс второго источника (в порядке перечисления в uird.homes=)\r\n      │   └── ...                       - и т.д.\r\n      ├── cmdline                   - системный файл для хранения дополнительных параметров командной строки\r\n      └── MagOS.ini.gz              - системный файл для хранения конфигурационного файла\r\n\r\n\r\n### Реализация\r\n\r\nВ основе реализации лежит набор скриптов инициализации dracut (модули base , busybox ) и скрипты uird (livekitlib+uird-init).\r\n\r\n    cmdline-hook: parse-root-uird.sh (проверяет параметр root=uird:)\r\n    mount-hook: mount-uird.sh (выполняет скрипт uird-init)\r\n\r\n* [livekitlib](https://github.com/magos-linux/magos-linux/blob/master/make_initrd/modules.d/97uird/livekit/livekitlib) - содержит библиотеку функций системы инициализации.\r\n* [uird-init](https://github.com/magos-linux/magos-linux/blob/master/make_initrd/modules.d/97uird/livekit/uird-init) - последовательно выполняет набор функций из livekitlib и осуществляет каскадно-блочное монтирование модулей системы в единый корень AUFS в директорию указанную в переменной dracut $NEWROOT.\r\n\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}